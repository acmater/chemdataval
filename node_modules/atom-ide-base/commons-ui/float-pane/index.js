"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PinnedDatatip = void 0;
const react_dom_1 = __importDefault(require("react-dom"));
const rxjs_1 = require("rxjs");
const assert_1 = __importDefault(require("assert"));
const atom_1 = __importDefault(require("atom"));
const ContentView_1 = require("./ContentView");
const isScrollable_1 = __importDefault(require("./isScrollable"));
const LINE_END_MARGIN = 20;
let _mouseMove$;
function documentMouseMove$() {
    if (_mouseMove$ == null) {
        _mouseMove$ = rxjs_1.Observable.fromEvent(document, 'mousemove');
    }
    return _mouseMove$;
}
let _mouseUp$;
function documentMouseUp$() {
    if (_mouseUp$ == null) {
        _mouseUp$ = rxjs_1.Observable.fromEvent(document, 'mouseup');
    }
    return _mouseUp$;
}
class PinnedDatatip {
    constructor(datatip, editor, params) {
        this._subscriptions = new atom_1.default();
        this._subscriptions.add(new atom_1.default(() => params.onDispose(this)));
        this._datatip = datatip;
        this._editor = editor;
        this._marker = null;
        this._rangeDecoration = null;
        this._hostElement = document.createElement('div');
        this._hostElement.className = 'datatip-element';
        this._boundDispose = this.dispose.bind(this);
        this._boundHandleMouseDown = this.handleMouseDown.bind(this);
        this._boundHandleMouseEnter = this.handleMouseEnter.bind(this);
        this._boundHandleMouseLeave = this.handleMouseLeave.bind(this);
        this._boundHandleCapturedClick = this.handleCapturedClick.bind(this);
        this._checkedScrollable = false;
        this._isScrollable = false;
        this._subscriptions.add(rxjs_1.Observable.fromEvent(this._hostElement, 'wheel').subscribe(e => {
            if (!this._checkedScrollable) {
                this._isScrollable = isScrollable_1.default(this._hostElement, e);
                this._checkedScrollable = true;
            }
            if (this._isScrollable) {
                e.stopPropagation();
            }
        }));
        this._hostElement.addEventListener('mouseenter', this._boundHandleMouseEnter);
        this._hostElement.addEventListener('mouseleave', this._boundHandleMouseLeave);
        this._subscriptions.add(new atom_1.default(() => {
            this._hostElement.removeEventListener('mouseenter', this._boundHandleMouseEnter);
            this._hostElement.removeEventListener('mouseleave', this._boundHandleMouseLeave);
        }));
        this._mouseUpTimeout = null;
        this._offset = { x: 0, y: 0 };
        this._isDragging = false;
        this._dragOrigin = null;
        this._isHovering = false;
        this._hideDataTips = params.hideDataTips;
        this._position = params.position == null ? 'end-of-line' : params.position;
        this._showRangeHighlight =
            params.showRangeHighlight == null ? true : params.showRangeHighlight;
        this.render();
    }
    handleMouseEnter(event) {
        this._isHovering = true;
        this._hideDataTips();
    }
    handleMouseLeave(event) {
        this._isHovering = false;
    }
    isHovering() {
        return this._isHovering;
    }
    handleGlobalMouseMove(event) {
        const evt = (event) => ;
        const { _dragOrigin } = this;
        assert_1.default(_dragOrigin);
        this._isDragging = true;
        this._offset = {
            x: evt.clientX - _dragOrigin.x,
            y: evt.clientY - _dragOrigin.y,
        };
        this.render();
    }
    handleGlobalMouseUp() {
        this._mouseUpTimeout = setTimeout(() => {
            this._isDragging = false;
            this._dragOrigin = null;
            this._mouseUpTimeout = null;
            this._ensureMouseSubscriptionDisposed();
            this.render();
        }, 0);
    }
    _ensureMouseSubscriptionDisposed() {
        if (this._mouseSubscription != null) {
            this._mouseSubscription.unsubscribe();
            this._mouseSubscription = null;
        }
    }
    handleMouseDown(event) {
        const evt = (event) => ;
        this._dragOrigin = {
            x: evt.clientX - this._offset.x,
            y: evt.clientY - this._offset.y,
        };
        this._ensureMouseSubscriptionDisposed();
        this._mouseSubscription = documentMouseMove$()
            .takeUntil(documentMouseUp$())
            .subscribe((e) => {
            this.handleGlobalMouseMove(e);
        }, (error) => { }, () => {
            this.handleGlobalMouseUp();
        });
    }
    handleCapturedClick(event) {
        if (this._isDragging) {
            event.stopPropagation();
        }
        else {
            this._checkedScrollable = false;
        }
    }
    _updateHostElementPosition() {
        const { _editor, _datatip, _hostElement, _offset, _position } = this;
        const { range } = _datatip;
        _hostElement.style.display = 'block';
        switch (_position) {
            case 'end-of-line':
                const charWidth = _editor.getDefaultCharWidth();
                const lineLength = _editor.getBuffer().getLines()[range.start.row]
                    .length;
                _hostElement.style.top =
                    -_editor.getLineHeightInPixels() + _offset.y + 'px';
                _hostElement.style.left =
                    (lineLength - range.end.column) * charWidth +
                        LINE_END_MARGIN +
                        _offset.x +
                        'px';
                break;
            case 'above-range':
                _hostElement.style.bottom =
                    _editor.getLineHeightInPixels() +
                        _hostElement.clientHeight -
                        _offset.y +
                        'px';
                _hostElement.style.left = _offset.x + 'px';
                break;
            default:
                (_position) => ;
                throw new Error(`Unexpected PinnedDatatip position: ${this._position}`);
        }
    }
    async render() {
        const { _editor, _datatip, _hostElement, _isDragging, _isHovering } = this;
        let rangeClassname = 'datatip-highlight-region';
        if (_isHovering) {
            rangeClassname += ' datatip-highlight-region-active';
        }
        if (this._marker == null) {
            const marker = _editor.markBufferRange(_datatip.range, {
                invalidate: 'never',
            });
            this._marker = marker;
            _editor.decorateMarker(marker, {
                type: 'overlay',
                position: 'head',
                class: 'datatip-pinned-overlay',
                item: this._hostElement,
                avoidOverflow: this._position !== 'above-range',
            });
            if (this._showRangeHighlight) {
                this._rangeDecoration = _editor.decorateMarker(marker, {
                    type: 'highlight',
                    class: rangeClassname,
                });
            }
            await _editor.getElement().getNextUpdatePromise();
            if (marker.isDestroyed() || _editor.isDestroyed()) {
                return;
            }
        }
        else if (this._rangeDecoration != null) {
            this._rangeDecoration.setProperties({
                type: 'highlight',
                class: rangeClassname,
            });
        }
        react_dom_1.default.render(action, { DATATIP_ACTIONS: ContentView_1.DATATIP_ACTIONS, : .CLOSE }, actionTitle = "Close this datatip", className = {}, datatip = { _datatip }, onActionClick = { this: ._boundDispose }, onMouseDown = { this: ._boundHandleMouseDown }, onClickCapture = { this: ._boundHandleCapturedClick }
            /  > , _hostElement);
        this._updateHostElementPosition();
    }
    dispose() {
        if (this._mouseUpTimeout != null) {
            clearTimeout(this._mouseUpTimeout);
        }
        if (this._marker != null) {
            this._marker.destroy();
        }
        if (this._mouseSubscription != null) {
            this._mouseSubscription.unsubscribe();
        }
        react_dom_1.default.unmountComponentAtNode(this._hostElement);
        this._hostElement.remove();
        this._subscriptions.dispose();
    }
}
exports.PinnedDatatip = PinnedDatatip;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMtY29tbW9ucy11aS9mbG9hdC1wYW5lL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQVFBLDBEQUFpQztBQUNqQywrQkFBZ0M7QUFDaEMsb0RBQStCO0FBRS9CLGdEQUE4QjtBQUU5QiwrQ0FBMkQ7QUFDM0Qsa0VBQTBDO0FBRTFDLE1BQU0sZUFBZSxHQUFHLEVBQUUsQ0FBQztBQUUzQixJQUFJLFdBQVcsQ0FBQztBQUNoQixTQUFTLGtCQUFrQjtJQUN6QixJQUFJLFdBQVcsSUFBSSxJQUFJLEVBQUU7UUFDdkIsV0FBVyxHQUFHLGlCQUFVLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQztLQUMzRDtJQUNELE9BQU8sV0FBVyxDQUFDO0FBQ3JCLENBQUM7QUFFRCxJQUFJLFNBQVMsQ0FBQztBQUNkLFNBQVMsZ0JBQWdCO0lBQ3ZCLElBQUksU0FBUyxJQUFJLElBQUksRUFBRTtRQUNyQixTQUFTLEdBQUcsaUJBQVUsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0tBQ3ZEO0lBQ0QsT0FBTyxTQUFTLENBQUM7QUFDbkIsQ0FBQztBQVdELE1BQWEsYUFBYTtJQTBCeEIsWUFDRSxPQUFnQixFQUNoQixNQUFrQixFQUNsQixNQUEyQjtRQUUzQixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksY0FBVSxFQUFFLENBQUM7UUFDdkMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQ3JCLElBQUksY0FBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FDN0MsQ0FBQztRQUNGLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FB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Q0FBQztJQUNoQyxDQUFDO0NBQ0Y7QUE1UUQsc0NBNFFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUge0RhdGF0aXAsIFBpbm5lZERhdGF0aXBQb3NpdGlvbn0gZnJvbSAnLi90eXBlcyc7XHJcblxyXG50eXBlIFBvc2l0aW9uID0ge1xyXG4gIHg6IG51bWJlcixcclxuICB5OiBudW1iZXIsXHJcbn07XHJcblxyXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XHJcbmltcG9ydCBSZWFjdERPTSBmcm9tICdyZWFjdC1kb20nO1xyXG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgaW52YXJpYW50IGZyb20gJ2Fzc2VydCc7XHJcbmltcG9ydCBjbGFzc25hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xyXG5pbXBvcnQgRGlzcG9zYWJsZSBmcm9tICdhdG9tJztcclxuXHJcbmltcG9ydCB7Q29udGVudFZpZXcsIERBVEFUSVBfQUNUSU9OU30gZnJvbSAnLi9Db250ZW50Vmlldyc7XHJcbmltcG9ydCBpc1Njcm9sbGFibGUgZnJvbSAnLi9pc1Njcm9sbGFibGUnO1xyXG5cclxuY29uc3QgTElORV9FTkRfTUFSR0lOID0gMjA7XHJcblxyXG5sZXQgX21vdXNlTW92ZSQ7XHJcbmZ1bmN0aW9uIGRvY3VtZW50TW91c2VNb3ZlJCgpOiBPYnNlcnZhYmxlPE1vdXNlRXZlbnQ+IHtcclxuICBpZiAoX21vdXNlTW92ZSQgPT0gbnVsbCkge1xyXG4gICAgX21vdXNlTW92ZSQgPSBPYnNlcnZhYmxlLmZyb21FdmVudChkb2N1bWVudCwgJ21vdXNlbW92ZScpO1xyXG4gIH1cclxuICByZXR1cm4gX21vdXNlTW92ZSQ7XHJcbn1cclxuXHJcbmxldCBfbW91c2VVcCQ7XHJcbmZ1bmN0aW9uIGRvY3VtZW50TW91c2VVcCQoKTogT2JzZXJ2YWJsZTxNb3VzZUV2ZW50PiB7XHJcbiAgaWYgKF9tb3VzZVVwJCA9PSBudWxsKSB7XHJcbiAgICBfbW91c2VVcCQgPSBPYnNlcnZhYmxlLmZyb21FdmVudChkb2N1bWVudCwgJ21vdXNldXAnKTtcclxuICB9XHJcbiAgcmV0dXJuIF9tb3VzZVVwJDtcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgUGlubmVkRGF0YXRpcFBhcmFtcyA9IHtcclxuICBvbkRpc3Bvc2U6IChwaW5uZWREYXRhdGlwOiBQaW5uZWREYXRhdGlwKSA9PiB2b2lkLFxyXG4gIGhpZGVEYXRhVGlwczogKCkgPT4gdm9pZCxcclxuICAvLyBEZWZhdWx0cyB0byAnZW5kLW9mLWxpbmUnLlxyXG4gIHBvc2l0aW9uPzogUGlubmVkRGF0YXRpcFBvc2l0aW9uLFxyXG4gIC8vIERlZmF1bHRzIHRvIHRydWUuXHJcbiAgc2hvd1JhbmdlSGlnaGxpZ2h0PzogYm9vbGVhbixcclxufTtcclxuXHJcbmV4cG9ydCBjbGFzcyBQaW5uZWREYXRhdGlwIHtcclxuICBfYm91bmREaXNwb3NlOiBGdW5jdGlvbjtcclxuICBfYm91bmRIYW5kbGVNb3VzZURvd246IEZ1bmN0aW9uO1xyXG4gIF9ib3VuZEhhbmRsZU1vdXNlRW50ZXI6IEZ1bmN0aW9uO1xyXG4gIF9ib3VuZEhhbmRsZU1vdXNlTGVhdmU6IEZ1bmN0aW9uO1xyXG4gIF9ib3VuZEhhbmRsZUNhcHR1cmVkQ2xpY2s6IEZ1bmN0aW9uO1xyXG4gIF9tb3VzZVVwVGltZW91dDogP1RpbWVvdXRJRDtcclxuICBfaG9zdEVsZW1lbnQ6IEhUTUxFbGVtZW50O1xyXG4gIF9tYXJrZXI6ID9hdG9tJE1hcmtlcjtcclxuICBfcmFuZ2VEZWNvcmF0aW9uOiA/YXRvbSREZWNvcmF0aW9uO1xyXG4gIF9tb3VzZVN1YnNjcmlwdGlvbjogP3J4anMkSVN1YnNjcmlwdGlvbjtcclxuICBfc3Vic2NyaXB0aW9uczogRGlzcG9zYWJsZTtcclxuICBfZGF0YXRpcDogRGF0YXRpcDtcclxuICBfZWRpdG9yOiBUZXh0RWRpdG9yO1xyXG4gIF9ob3N0RWxlbWVudDogSFRNTEVsZW1lbnQ7XHJcbiAgX2JvdW5kRGlzcG9zZTogRnVuY3Rpb247XHJcbiAgX2RyYWdPcmlnaW46ID9Qb3NpdGlvbjtcclxuICBfaXNEcmFnZ2luZzogYm9vbGVhbjtcclxuICBfb2Zmc2V0OiBQb3NpdGlvbjtcclxuICBfaXNIb3ZlcmluZzogYm9vbGVhbjtcclxuICBfY2hlY2tlZFNjcm9sbGFibGU6IGJvb2xlYW47XHJcbiAgX2lzU2Nyb2xsYWJsZTogYm9vbGVhbjtcclxuICBfaGlkZURhdGFUaXBzOiAoKSA9PiB2b2lkO1xyXG4gIF9wb3NpdGlvbjogUGlubmVkRGF0YXRpcFBvc2l0aW9uO1xyXG4gIF9zaG93UmFuZ2VIaWdobGlnaHQ6IGJvb2xlYW47XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgZGF0YXRpcDogRGF0YXRpcCxcclxuICAgIGVkaXRvcjogVGV4dEVkaXRvcixcclxuICAgIHBhcmFtczogUGlubmVkRGF0YXRpcFBhcmFtcyxcclxuICApIHtcclxuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSBuZXcgRGlzcG9zYWJsZSgpO1xyXG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5hZGQoXHJcbiAgICAgIG5ldyBEaXNwb3NhYmxlKCgpID0+IHBhcmFtcy5vbkRpc3Bvc2UodGhpcykpLFxyXG4gICAgKTtcclxuICAgIHRoaXMuX2RhdGF0aXAgPSBkYXRhdGlwO1xyXG4gICAgdGhpcy5fZWRpdG9yID0gZWRpdG9yO1xyXG4gICAgdGhpcy5fbWFya2VyID0gbnVsbDtcclxuICAgIHRoaXMuX3JhbmdlRGVjb3JhdGlvbiA9IG51bGw7XHJcbiAgICB0aGlzLl9ob3N0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgdGhpcy5faG9zdEVsZW1lbnQuY2xhc3NOYW1lID0gJ2RhdGF0aXAtZWxlbWVudCc7XHJcbiAgICB0aGlzLl9ib3VuZERpc3Bvc2UgPSB0aGlzLmRpc3Bvc2UuYmluZCh0aGlzKTtcclxuICAgIHRoaXMuX2JvdW5kSGFuZGxlTW91c2VEb3duID0gdGhpcy5oYW5kbGVNb3VzZURvd24uYmluZCh0aGlzKTtcclxuICAgIHRoaXMuX2JvdW5kSGFuZGxlTW91c2VFbnRlciA9IHRoaXMuaGFuZGxlTW91c2VFbnRlci5iaW5kKHRoaXMpO1xyXG4gICAgdGhpcy5fYm91bmRIYW5kbGVNb3VzZUxlYXZlID0gdGhpcy5oYW5kbGVNb3VzZUxlYXZlLmJpbmQodGhpcyk7XHJcbiAgICB0aGlzLl9ib3VuZEhhbmRsZUNhcHR1cmVkQ2xpY2sgPSB0aGlzLmhhbmRsZUNhcHR1cmVkQ2xpY2suYmluZCh0aGlzKTtcclxuICAgIHRoaXMuX2NoZWNrZWRTY3JvbGxhYmxlID0gZmFsc2U7XHJcbiAgICB0aGlzLl9pc1Njcm9sbGFibGUgPSBmYWxzZTtcclxuXHJcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zLmFkZChcclxuICAgICAgT2JzZXJ2YWJsZS5mcm9tRXZlbnQodGhpcy5faG9zdEVsZW1lbnQsICd3aGVlbCcpLnN1YnNjcmliZShlID0+IHtcclxuICAgICAgICBpZiAoIXRoaXMuX2NoZWNrZWRTY3JvbGxhYmxlKSB7XHJcbiAgICAgICAgICB0aGlzLl9pc1Njcm9sbGFibGUgPSBpc1Njcm9sbGFibGUodGhpcy5faG9zdEVsZW1lbnQsIGUpO1xyXG4gICAgICAgICAgdGhpcy5fY2hlY2tlZFNjcm9sbGFibGUgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5faXNTY3JvbGxhYmxlKSB7XHJcbiAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSksXHJcbiAgICApO1xyXG4gICAgdGhpcy5faG9zdEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcclxuICAgICAgJ21vdXNlZW50ZXInLFxyXG4gICAgICB0aGlzLl9ib3VuZEhhbmRsZU1vdXNlRW50ZXIsXHJcbiAgICApO1xyXG4gICAgdGhpcy5faG9zdEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcclxuICAgICAgJ21vdXNlbGVhdmUnLFxyXG4gICAgICB0aGlzLl9ib3VuZEhhbmRsZU1vdXNlTGVhdmUsXHJcbiAgICApO1xyXG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5hZGQoXHJcbiAgICAgIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcclxuICAgICAgICB0aGlzLl9ob3N0RWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFxyXG4gICAgICAgICAgJ21vdXNlZW50ZXInLFxyXG4gICAgICAgICAgdGhpcy5fYm91bmRIYW5kbGVNb3VzZUVudGVyLFxyXG4gICAgICAgICk7XHJcbiAgICAgICAgdGhpcy5faG9zdEVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcclxuICAgICAgICAgICdtb3VzZWxlYXZlJyxcclxuICAgICAgICAgIHRoaXMuX2JvdW5kSGFuZGxlTW91c2VMZWF2ZSxcclxuICAgICAgICApO1xyXG4gICAgICB9KSxcclxuICAgICk7XHJcbiAgICB0aGlzLl9tb3VzZVVwVGltZW91dCA9IG51bGw7XHJcbiAgICB0aGlzLl9vZmZzZXQgPSB7eDogMCwgeTogMH07XHJcbiAgICB0aGlzLl9pc0RyYWdnaW5nID0gZmFsc2U7XHJcbiAgICB0aGlzLl9kcmFnT3JpZ2luID0gbnVsbDtcclxuICAgIHRoaXMuX2lzSG92ZXJpbmcgPSBmYWxzZTtcclxuICAgIHRoaXMuX2hpZGVEYXRhVGlwcyA9IHBhcmFtcy5oaWRlRGF0YVRpcHM7XHJcbiAgICB0aGlzLl9wb3NpdGlvbiA9IHBhcmFtcy5wb3NpdGlvbiA9PSBudWxsID8gJ2VuZC1vZi1saW5lJyA6IHBhcmFtcy5wb3NpdGlvbjtcclxuICAgIHRoaXMuX3Nob3dSYW5nZUhpZ2hsaWdodCA9XHJcbiAgICAgIHBhcmFtcy5zaG93UmFuZ2VIaWdobGlnaHQgPT0gbnVsbCA/IHRydWUgOiBwYXJhbXMuc2hvd1JhbmdlSGlnaGxpZ2h0O1xyXG4gICAgdGhpcy5yZW5kZXIoKTtcclxuICB9XHJcblxyXG4gIGhhbmRsZU1vdXNlRW50ZXIoZXZlbnQ6IE1vdXNlRXZlbnQpOiB2b2lkIHtcclxuICAgIHRoaXMuX2lzSG92ZXJpbmcgPSB0cnVlO1xyXG4gICAgdGhpcy5faGlkZURhdGFUaXBzKCk7XHJcbiAgfVxyXG5cclxuICBoYW5kbGVNb3VzZUxlYXZlKGV2ZW50OiBNb3VzZUV2ZW50KTogdm9pZCB7XHJcbiAgICB0aGlzLl9pc0hvdmVyaW5nID0gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBpc0hvdmVyaW5nKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX2lzSG92ZXJpbmc7XHJcbiAgfVxyXG5cclxuICBoYW5kbGVHbG9iYWxNb3VzZU1vdmUoZXZlbnQ6IEV2ZW50KTogdm9pZCB7XHJcbiAgICBjb25zdCBldnQ6IE1vdXNlRXZlbnQgPSAoZXZlbnQ6IGFueSk7XHJcbiAgICBjb25zdCB7X2RyYWdPcmlnaW59ID0gdGhpcztcclxuICAgIGludmFyaWFudChfZHJhZ09yaWdpbik7XHJcbiAgICB0aGlzLl9pc0RyYWdnaW5nID0gdHJ1ZTtcclxuICAgIHRoaXMuX29mZnNldCA9IHtcclxuICAgICAgeDogZXZ0LmNsaWVudFggLSBfZHJhZ09yaWdpbi54LFxyXG4gICAgICB5OiBldnQuY2xpZW50WSAtIF9kcmFnT3JpZ2luLnksXHJcbiAgICB9O1xyXG4gICAgdGhpcy5yZW5kZXIoKTtcclxuICB9XHJcblxyXG4gIGhhbmRsZUdsb2JhbE1vdXNlVXAoKTogdm9pZCB7XHJcbiAgICAvLyBJZiB0aGUgZGF0YXRpcCB3YXMgbW92ZWQsIHB1c2ggdGhlIGVmZmVjdHMgb2YgbW91c2VVcCB0byB0aGUgbmV4dCB0aWNrLFxyXG4gICAgLy8gaW4gb3JkZXIgdG8gYWxsb3cgY2FuY2VsbGF0aW9uIG9mIGNhcHR1cmVkIGV2ZW50cyAoZS5nLiBjbGlja3Mgb24gY2hpbGQgY29tcG9uZW50cykuXHJcbiAgICB0aGlzLl9tb3VzZVVwVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICB0aGlzLl9pc0RyYWdnaW5nID0gZmFsc2U7XHJcbiAgICAgIHRoaXMuX2RyYWdPcmlnaW4gPSBudWxsO1xyXG4gICAgICB0aGlzLl9tb3VzZVVwVGltZW91dCA9IG51bGw7XHJcbiAgICAgIHRoaXMuX2Vuc3VyZU1vdXNlU3Vic2NyaXB0aW9uRGlzcG9zZWQoKTtcclxuICAgICAgdGhpcy5yZW5kZXIoKTtcclxuICAgIH0sIDApO1xyXG4gIH1cclxuXHJcbiAgX2Vuc3VyZU1vdXNlU3Vic2NyaXB0aW9uRGlzcG9zZWQoKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5fbW91c2VTdWJzY3JpcHRpb24gIT0gbnVsbCkge1xyXG4gICAgICB0aGlzLl9tb3VzZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICB0aGlzLl9tb3VzZVN1YnNjcmlwdGlvbiA9IG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBoYW5kbGVNb3VzZURvd24oZXZlbnQ6IEV2ZW50KTogdm9pZCB7XHJcbiAgICBjb25zdCBldnQ6IE1vdXNlRXZlbnQgPSAoZXZlbnQ6IGFueSk7XHJcbiAgICB0aGlzLl9kcmFnT3JpZ2luID0ge1xyXG4gICAgICB4OiBldnQuY2xpZW50WCAtIHRoaXMuX29mZnNldC54LFxyXG4gICAgICB5OiBldnQuY2xpZW50WSAtIHRoaXMuX29mZnNldC55LFxyXG4gICAgfTtcclxuICAgIHRoaXMuX2Vuc3VyZU1vdXNlU3Vic2NyaXB0aW9uRGlzcG9zZWQoKTtcclxuICAgIHRoaXMuX21vdXNlU3Vic2NyaXB0aW9uID0gZG9jdW1lbnRNb3VzZU1vdmUkKClcclxuICAgICAgLnRha2VVbnRpbChkb2N1bWVudE1vdXNlVXAkKCkpXHJcbiAgICAgIC5zdWJzY3JpYmUoXHJcbiAgICAgICAgKGU6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgIHRoaXMuaGFuZGxlR2xvYmFsTW91c2VNb3ZlKGUpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKGVycm9yOiBhbnkpID0+IHt9LFxyXG4gICAgICAgICgpID0+IHtcclxuICAgICAgICAgIHRoaXMuaGFuZGxlR2xvYmFsTW91c2VVcCgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICk7XHJcbiAgfVxyXG5cclxuICBoYW5kbGVDYXB0dXJlZENsaWNrKGV2ZW50OiBTeW50aGV0aWNFdmVudDw+KTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5faXNEcmFnZ2luZykge1xyXG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIEhhdmUgdG8gcmUtY2hlY2sgc2Nyb2xsaW5nIGJlY2F1c2UgdGhlIGRhdGF0aXAgc2l6ZSBtYXkgaGF2ZSBjaGFuZ2VkLlxyXG4gICAgICB0aGlzLl9jaGVja2VkU2Nyb2xsYWJsZSA9IGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gVXBkYXRlIHRoZSBwb3NpdGlvbiBvZiB0aGUgcGlubmVkIGRhdGF0aXAuXHJcbiAgX3VwZGF0ZUhvc3RFbGVtZW50UG9zaXRpb24oKTogdm9pZCB7XHJcbiAgICBjb25zdCB7X2VkaXRvciwgX2RhdGF0aXAsIF9ob3N0RWxlbWVudCwgX29mZnNldCwgX3Bvc2l0aW9ufSA9IHRoaXM7XHJcbiAgICBjb25zdCB7cmFuZ2V9ID0gX2RhdGF0aXA7XHJcbiAgICBfaG9zdEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XHJcbiAgICBzd2l0Y2ggKF9wb3NpdGlvbikge1xyXG4gICAgICBjYXNlICdlbmQtb2YtbGluZSc6XHJcbiAgICAgICAgY29uc3QgY2hhcldpZHRoID0gX2VkaXRvci5nZXREZWZhdWx0Q2hhcldpZHRoKCk7XHJcbiAgICAgICAgY29uc3QgbGluZUxlbmd0aCA9IF9lZGl0b3IuZ2V0QnVmZmVyKCkuZ2V0TGluZXMoKVtyYW5nZS5zdGFydC5yb3ddXHJcbiAgICAgICAgICAubGVuZ3RoO1xyXG4gICAgICAgIF9ob3N0RWxlbWVudC5zdHlsZS50b3AgPVxyXG4gICAgICAgICAgLV9lZGl0b3IuZ2V0TGluZUhlaWdodEluUGl4ZWxzKCkgKyBfb2Zmc2V0LnkgKyAncHgnO1xyXG4gICAgICAgIF9ob3N0RWxlbWVudC5zdHlsZS5sZWZ0ID1cclxuICAgICAgICAgIChsaW5lTGVuZ3RoIC0gcmFuZ2UuZW5kLmNvbHVtbikgKiBjaGFyV2lkdGggK1xyXG4gICAgICAgICAgTElORV9FTkRfTUFSR0lOICtcclxuICAgICAgICAgIF9vZmZzZXQueCArXHJcbiAgICAgICAgICAncHgnO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBjYXNlICdhYm92ZS1yYW5nZSc6XHJcbiAgICAgICAgX2hvc3RFbGVtZW50LnN0eWxlLmJvdHRvbSA9XHJcbiAgICAgICAgICBfZWRpdG9yLmdldExpbmVIZWlnaHRJblBpeGVscygpICtcclxuICAgICAgICAgIF9ob3N0RWxlbWVudC5jbGllbnRIZWlnaHQgLVxyXG4gICAgICAgICAgX29mZnNldC55ICtcclxuICAgICAgICAgICdweCc7XHJcbiAgICAgICAgX2hvc3RFbGVtZW50LnN0eWxlLmxlZnQgPSBfb2Zmc2V0LnggKyAncHgnO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIChfcG9zaXRpb246IGVtcHR5KTtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgUGlubmVkRGF0YXRpcCBwb3NpdGlvbjogJHt0aGlzLl9wb3NpdGlvbn1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIHJlbmRlcigpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IHtfZWRpdG9yLCBfZGF0YXRpcCwgX2hvc3RFbGVtZW50LCBfaXNEcmFnZ2luZywgX2lzSG92ZXJpbmd9ID0gdGhpcztcclxuXHJcbiAgICBsZXQgcmFuZ2VDbGFzc25hbWUgPSAnZGF0YXRpcC1oaWdobGlnaHQtcmVnaW9uJztcclxuICAgIGlmIChfaXNIb3ZlcmluZykge1xyXG4gICAgICByYW5nZUNsYXNzbmFtZSArPSAnIGRhdGF0aXAtaGlnaGxpZ2h0LXJlZ2lvbi1hY3RpdmUnO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLl9tYXJrZXIgPT0gbnVsbCkge1xyXG4gICAgICBjb25zdCBtYXJrZXI6IGF0b20kTWFya2VyID0gX2VkaXRvci5tYXJrQnVmZmVyUmFuZ2UoX2RhdGF0aXAucmFuZ2UsIHtcclxuICAgICAgICBpbnZhbGlkYXRlOiAnbmV2ZXInLFxyXG4gICAgICB9KTtcclxuICAgICAgdGhpcy5fbWFya2VyID0gbWFya2VyO1xyXG4gICAgICBfZWRpdG9yLmRlY29yYXRlTWFya2VyKG1hcmtlciwge1xyXG4gICAgICAgIHR5cGU6ICdvdmVybGF5JyxcclxuICAgICAgICBwb3NpdGlvbjogJ2hlYWQnLFxyXG4gICAgICAgIGNsYXNzOiAnZGF0YXRpcC1waW5uZWQtb3ZlcmxheScsXHJcbiAgICAgICAgaXRlbTogdGhpcy5faG9zdEVsZW1lbnQsXHJcbiAgICAgICAgLy8gYWJvdmUtcmFuZ2UgZGF0YXRpcHMgY3VycmVudGx5IGFzc3VtZSB0aGF0IHRoZSBvdmVybGF5IGlzIGJlbG93LlxyXG4gICAgICAgIGF2b2lkT3ZlcmZsb3c6IHRoaXMuX3Bvc2l0aW9uICE9PSAnYWJvdmUtcmFuZ2UnLFxyXG4gICAgICB9KTtcclxuICAgICAgaWYgKHRoaXMuX3Nob3dSYW5nZUhpZ2hsaWdodCkge1xyXG4gICAgICAgIHRoaXMuX3JhbmdlRGVjb3JhdGlvbiA9IF9lZGl0b3IuZGVjb3JhdGVNYXJrZXIobWFya2VyLCB7XHJcbiAgICAgICAgICB0eXBlOiAnaGlnaGxpZ2h0JyxcclxuICAgICAgICAgIGNsYXNzOiByYW5nZUNsYXNzbmFtZSxcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICBhd2FpdCBfZWRpdG9yLmdldEVsZW1lbnQoKS5nZXROZXh0VXBkYXRlUHJvbWlzZSgpO1xyXG4gICAgICAvLyBHdWFyZCBhZ2FpbnN0IGRpc3Bvc2FscyBkdXJpbmcgdGhlIGF3YWl0LlxyXG4gICAgICBpZiAobWFya2VyLmlzRGVzdHJveWVkKCkgfHwgX2VkaXRvci5pc0Rlc3Ryb3llZCgpKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuX3JhbmdlRGVjb3JhdGlvbiAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMuX3JhbmdlRGVjb3JhdGlvbi5zZXRQcm9wZXJ0aWVzKHtcclxuICAgICAgICB0eXBlOiAnaGlnaGxpZ2h0JyxcclxuICAgICAgICBjbGFzczogcmFuZ2VDbGFzc25hbWUsXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIFJlYWN0RE9NLnJlbmRlcihcclxuICAgICAgPENvbnRlbnRWaWV3XHJcbiAgICAgICAgYWN0aW9uPXtEQVRBVElQX0FDVElPTlMuQ0xPU0V9XHJcbiAgICAgICAgYWN0aW9uVGl0bGU9XCJDbG9zZSB0aGlzIGRhdGF0aXBcIlxyXG4gICAgICAgIGNsYXNzTmFtZT17Y2xhc3NuYW1lcyhcclxuICAgICAgICAgIF9pc0RyYWdnaW5nID8gJ2RhdGF0aXAtZHJhZ2dpbmcnIDogJycsXHJcbiAgICAgICAgICAnZGF0YXRpcC1waW5uZWQnLFxyXG4gICAgICAgICl9XHJcbiAgICAgICAgZGF0YXRpcD17X2RhdGF0aXB9XHJcbiAgICAgICAgb25BY3Rpb25DbGljaz17dGhpcy5fYm91bmREaXNwb3NlfVxyXG4gICAgICAgIG9uTW91c2VEb3duPXt0aGlzLl9ib3VuZEhhbmRsZU1vdXNlRG93bn1cclxuICAgICAgICBvbkNsaWNrQ2FwdHVyZT17dGhpcy5fYm91bmRIYW5kbGVDYXB0dXJlZENsaWNrfVxyXG4gICAgICAvPixcclxuICAgICAgX2hvc3RFbGVtZW50LFxyXG4gICAgKTtcclxuICAgIHRoaXMuX3VwZGF0ZUhvc3RFbGVtZW50UG9zaXRpb24oKTtcclxuICB9XHJcblxyXG4gIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5fbW91c2VVcFRpbWVvdXQgIT0gbnVsbCkge1xyXG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5fbW91c2VVcFRpbWVvdXQpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuX21hcmtlciAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMuX21hcmtlci5kZXN0cm95KCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5fbW91c2VTdWJzY3JpcHRpb24gIT0gbnVsbCkge1xyXG4gICAgICB0aGlzLl9tb3VzZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG4gICAgUmVhY3RET00udW5tb3VudENvbXBvbmVudEF0Tm9kZSh0aGlzLl9ob3N0RWxlbWVudCk7XHJcbiAgICB0aGlzLl9ob3N0RWxlbWVudC5yZW1vdmUoKTtcclxuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG4iXX0=